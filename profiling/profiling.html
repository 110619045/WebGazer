<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
    <head>
        <META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=utf-8">
        <TITLE>Profiling</TITLE>
        <style>
        #myCanvas {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 100%;
        }
        #webgazerVideoFeed {
            position: absolute;
            top: 50%;
            left: 50%;
            margin: -180px 0 0 -240px;
        }   

        #overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            margin: -180px 0 0 -240px;
        }

        #rightEyeCanvas {
            position: absolute;
            left: 100;
        }

        #statistics {
            position: absolute;
            text-align:right;
        }
        </style>


    </head>
    <BODY LANG="en-US" LINK="#0000ff" DIR="LTR">
        <canvas id="myCanvas" width="578" height="200"></canvas>
        <canvas id="leftEyeCanvas" width="300px" height="180px"></canvas>
        <canvas id="rightEyeCanvas" width="300px" height="180px"></canvas>
        <div id="chartContainer" style="height: 300px; width:300px;">

        <script type="text/javascript" src="canvasjs.min.js"></script>
        <script src="/build/gazer.js"></script>

        <script>

            var localstorageLabel = 'webgazerGlobalData';
            window.localStorage.setItem(localstorageLabel, null);
            var leftEyeElem = document.getElementById('leftEyeCanvas');
            var rightEyeElem = document.getElementById('rightEyeCanvas');
            
            gazer.setRegression('interaction') /* currently must set regression and tracker */
                .setTracker('trackingjs')
                .setGazeListener(function(data, clock) {
                    if (!data) {
                        return;
                    }

                    var leftEye = data.all[0].eyes.left.patch;
                    leftEyeCanvas.width = 300;
                    leftEyeElem.getContext('2d').scale(4,4);
                    leftEyeElem.getContext('2d').putImageData(leftEye,0,0);

                    var rightEye = data.all[0].eyes.right.patch;
                    rightEyeCanvas.width = 300;
                    rightEyeElem.getContext('2d').scale(4,4);
                    rightEyeElem.getContext('2d').putImageData(rightEye,0,0);
                })
                .setStaticVideo("videos/video1.mp4")
                .begin()
                .showPredictionPoints(true); /* shows a square every 100 milliseconds where current prediction is */

            var canvas = document.getElementById('myCanvas');
            var context = canvas.getContext('2d');
            canvas.width  = window.innerWidth;
            canvas.height = window.innerHeight;

            var drawCircle = function(x,y, radius, color) {
                context.beginPath();
                context.arc(x, y, radius, 0, 2 * Math.PI, false);
                context.fillStyle = color || 'green';
                context.fill();
            }   

            var genRow = function(numPoints, y, width, padding) {
                var row = [];
                var spacing = (width - (2 * padding)) / (numPoints - 1);
                for (var i = 0; i < numPoints; i++) {
                    row.push([padding + (i * spacing), y]);
                }
                return row;
            };


            var genCoords = function(xNum, yNum, width, height, padding, stagger, staggerXNum) {
                var rows = [];
                var spacing = (height - (2 * padding)) / (yNum - 1);
                for (var i = 0; i < yNum; i++) {
                    var y = padding + (i * spacing);
                    if (stagger && (i % 2 == 1)) {
                        rows.push(genRow(staggerXNum, y, width, padding + (spacing / 2)));
                    } else {
                        rows.push(genRow(xNum, y, width, padding));
                    }
                }
                return [].concat.apply([], rows);
            };

            var randomizer = function(coordinates){

                var dps = []; // dataPoints

                var chart = new CanvasJS.Chart("chartContainer",{
                    title :{
                        text: "Error"
                    },          
                    data: [{
                        type: "line",
                        dataPoints: dps 
                    }]
                });

                var xVal = 0;
                var yVal = 100; 
                var updateInterval = 100;
                var dataLength = 500; // number of dataPoints visible at any point

                var updateChart = function (error) {
                        dps.push({
                            x: xVal,
                            y: error
                        });
                        xVal++;
                    if (dps.length > dataLength)
                    {
                        dps.shift();                
                    }
                    chart.render();     

                };

                var counter = 0;
                var caliRadius = 20;
                centerX = coordinates[counter][0];
                centerY = coordinates[counter][1];
                drawCircle(centerX, centerY, caliRadius); 
                simulateClick(centerX, centerY);
                counter++;

                counter2 = 0;
                var timerID2 = setInterval(function(){
                    if(counter2<60){
                        simulateClick(centerX, centerY);
                        var boundedPrediction = gazer.util.bound(gazer.getCurrentPrediction());
                        var x = boundedPrediction.x;
                        var y = boundedPrediction.y;
                        var error = Math.sqrt(Math.pow((x - centerX),2) + Math.pow((y - centerY),2));                  
                        updateChart(error); 
                        counter2++;
                    }
                    else{
                        clearInterval(timerID2);
                    }
                },100);

                var timerID = setInterval(function() {
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    if (counter<coordinates.length){
                        centerX = coordinates[counter][0];
                        centerY = coordinates[counter][1];
                        drawCircle(centerX, centerY, caliRadius); 

                        counter2 = 0;
                        var timerID2 = setInterval(function(){
                            if(counter2<60){
                                simulateClick(centerX, centerY);
                                counter2++;
                                var boundedPrediction = gazer.util.bound(gazer.getCurrentPrediction());
                                var x = boundedPrediction.x;
                                var y = boundedPrediction.y;
                                var error = Math.sqrt(Math.pow((x - centerX),2) + Math.pow((y - centerY),2));
                                updateChart(error); 
                            }
                            else{
                                clearInterval(timerID2);
                            }
                        },100);
                        counter++;
                    }
                    else{
                        clearInterval(timerID);
                    }
                }, 7000); 
            };

            var setup = function() {
                var vid = document.getElementById("webgazerVideoFeed");
                vid.style.display = "block";
                vid.width = 400;
                vid.height = 400;
                vid.play();
                
                // //For clmtrackr
                var ctrack = new clm.tracker({useWebGL : true});
                ctrack.init(pModel);
                ctrack.start(vid);

                //var coordinates = genCoords(3, 3, canvas.width, canvas.height, 30, false);
                coordinates =  [[30,30],
                    [canvas.width - 30,30],
                    [30,canvas.height - 30],
                    [canvas.width - 30, canvas.height - 30],
                    [canvas.width/2, canvas.height/2]
                ];

                found = false;

                function drawLoop() {
                    requestAnimFrame(drawLoop);
                    if (ctrack.getCurrentPosition() && !found) {
                        randomizer(coordinates);
                        found = true;
                    }
                }   

                drawLoop();             
            };

            var simulateClick = function(x,y){
                var clickEvent= document.createEvent('MouseEvents');
                clickEvent.initMouseEvent(
                'click', true, true, window, 0,
                0, 0, x, y, false, false,
                false, false, 0, null
                );
                document.elementFromPoint(x, y).dispatchEvent(clickEvent);
            }

            function checkIfReady() {
                if (gazer.isReady()) {
                    setup();
                } else {
                    if(document.getElementById("webgazerVideoFeed"))
                        document.getElementById("webgazerVideoFeed").pause();
                    setTimeout(checkIfReady, 100);
                }
            }
            setTimeout(checkIfReady,100);
            document.getElementById('webgazerVideoFeed').addEventListener('ended',myHandler,false);
            function myHandler(e) {
                console.log("Entire video was shown")
                console.profileEnd();    
            }

        </script>
    </BODY>
</HTML>
