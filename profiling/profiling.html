<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
    <head>
        <META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=utf-8">
        <TITLE>Profiling</TITLE>
        <style>
        #myCanvas {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 100%;
        }
        #webgazerVideoFeed {
            position: absolute;
            top: 50%;
            left: 50%;
            margin: -180px 0 0 -240px;
        }        

        #overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            margin: -180px 0 0 -240px;
        }

        #liveVideoFeed {
            position: absolute;
            top: 50%;
            left: 50%;
            margin: -180px 0 0 -240px;
        }
        </style>


    </head>
    <BODY LANG="en-US" LINK="#0000ff" DIR="LTR">
        <canvas id="myCanvas" width="578" height="200"></canvas>
       Â <!--<video autoplay="true" id="liveVideoFeed"></video>-->
        <script src="/build/gazer.js"></script>
        <script>
            
            //for live video feed from webcam
            //var video = document.querySelector("#liveVideoFeed");
            // navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mediaDevices.getUserMedia || navigator.msGetUserMedia || navigator.oGetUserMedia;
            // if (navigator.getUserMedia) {       
            //     navigator.getUserMedia({video: true}, handleVideo, videoError);
            // }
            // function handleVideo(stream) {
            //     video.src = window.URL.createObjectURL(stream);
            // }
            // function videoError(e) {
            //     console.log("Something went wrong")
            // }

            // var overlay = document.createElement('canvas');
            // overlay.id = 'overlay';
            // overlay.style.width = "400px";
            // overlay.style.height = "400px";
            // document.body.appendChild(overlay);

            // var cl = gazer.getTracker().clm;

            // function drawLoop() {
            //     requestAnimFrame(drawLoop);
            //     overlay.getContext('2d').clearRect(0,0,overlay.width,overlay.height);
            //     if (cl.getCurrentPosition()) {
            //         cl.draw(overlay);
            //     }
            // }
            // drawLoop();


            var localstorageLabel = 'webgazerGlobalData';
            window.localStorage.setItem(localstorageLabel, null);
            gazer.setRegression('interaction') /* currently must set regression and tracker */
                .setTracker('clmtrackr')
                .setGazeListener(function(data, clock) {
                })
                .setStaticVideo("videos/video12.mp4")
                .begin()
                .showPredictionPoints(true); /* shows a square every 100 milliseconds where current prediction is */

            var canvas = document.getElementById('myCanvas');
            var context = canvas.getContext('2d');
            canvas.width  = window.innerWidth;
            canvas.height = window.innerHeight;

            var drawCircle = function(x,y, radius, color) {
                context.beginPath();
                context.arc(x, y, radius, 0, 2 * Math.PI, false);
                context.fillStyle = color || 'green';
                context.fill();
            }   

            var genRow = function(numPoints, y, width, padding) {
                var row = [];
                var spacing = (width - (2 * padding)) / (numPoints - 1);
                for (var i = 0; i < numPoints; i++) {
                    row.push([padding + (i * spacing), y]);
                }
                return row;
            };


            var genCoords = function(xNum, yNum, width, height, padding, stagger, staggerXNum) {
                var rows = [];
                var spacing = (height - (2 * padding)) / (yNum - 1);
                for (var i = 0; i < yNum; i++) {
                    var y = padding + (i * spacing);
                    if (stagger && (i % 2 == 1)) {
                        rows.push(genRow(staggerXNum, y, width, padding + (spacing / 2)));
                    } else {
                        rows.push(genRow(xNum, y, width, padding));
                    }
                }
                return [].concat.apply([], rows);
            };

            var randomizer = function(coordinates){
                var counter = 0;
                var caliRadius = 20;
                centerX = coordinates[counter][0];
                centerY = coordinates[counter][1];
                drawCircle(centerX, centerY, caliRadius); 
                simulateClick(centerX, centerY);
                counter++;

                counter2 = 0;
                var timerID2 = setInterval(function(){
                    if(counter2<60){
                        simulateClick(centerX, centerY);
                        counter2++;
                    }
                    else{
                        clearInterval(timerID2);
                    }
                },100);

                var timerID = setInterval(function() {
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    if (counter<coordinates.length){
                        centerX = coordinates[counter][0];
                        centerY = coordinates[counter][1];
                        drawCircle(centerX, centerY, caliRadius); 

                        counter2 = 0;
                        var timerID2 = setInterval(function(){
                            if(counter2<60){
                                simulateClick(centerX, centerY);
                                counter2++;
                            }
                            else{
                                clearInterval(timerID2);
                            }
                        },100);
                        counter++;
                    }
                    else{
                        clearInterval(timerID);
                    }
                }, 7000); 
            };

            var setup = function() {
                var vid = document.getElementById("webgazerVideoFeed");
                vid.style.display = "block";
                vid.style.width = "400px";
                vid.style.height = "400px";
                //vid.autoplay = true;
                vid.load();

                //var coordinates = genCoords(3, 3, canvas.width, canvas.height, 30, false);
                var coordinates =  [[30,30],
                    [canvas.width - 30,30],
                    [30,canvas.height - 30],
                    [canvas.width - 30, canvas.height - 30],
                    [canvas.width/2, canvas.height/2]
                ];
                randomizer(coordinates);

            };

            var simulateClick = function(x,y){
                var clickEvent= document.createEvent('MouseEvents');
                clickEvent.initMouseEvent(
                'click', true, true, window, 0,
                0, 0, x, y, false, false,
                false, false, 0, null
                );
                document.elementFromPoint(x, y).dispatchEvent(clickEvent);
            }

            //setup();
            document.getElementById('webgazerVideoFeed').addEventListener('ended',myHandler,false);
            function myHandler(e) {
                console.log("Entire video was shown")
                console.profileEnd();    
            }

        </script>
    </BODY>
</HTML>
